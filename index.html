<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="AI-powered Tarot Card Reading - Get instant insights and guidance">
    <title>AI Tarot - æ™ºèƒ½å¡”ç¾…ç‰Œ</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%236366f1' width='192' height='192' rx='32'/><text x='96' y='140' font-size='100' text-anchor='middle'>ğŸ”®</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f59e0b;
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-elevated: #252542;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-purple: #a855f7;
            --accent-pink: #ec4899;
            --success: #10b981;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
        }

        /* Background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* Header */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(15, 15, 26, 0.85);
            backdrop-filter: blur(20px);
            padding: 16px 20px;
            padding-top: calc(16px + env(safe-area-inset-top));
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .header-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--secondary), var(--accent-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:active {
            transform: scale(0.95);
            background: var(--primary);
        }

        /* Main Content */
        main {
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 20px calc(100px + env(safe-area-inset-bottom, 20px));
        }

        /* Hero Section */
        .hero {
            text-align: center;
            padding: 20px 0 32px;
        }

        .hero h1 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .hero p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Card Display Area */
        .card-area {
            min-height: 260px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            padding: 10px;
        }

        .card-placeholder {
            width: 160px;
            height: 240px;
            background: linear-gradient(145deg, var(--bg-elevated), var(--bg-card));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            border: 2px dashed rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        .card-placeholder::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--primary), var(--accent-purple));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card-placeholder:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .card-placeholder:active {
            transform: scale(0.95) translateY(0);
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.2);
        }

        .card-placeholder.tapping {
            transform: scale(0.92);
            background: linear-gradient(145deg, var(--primary-dark), var(--primary));
        }

        .card-placeholder.revealed {
            border: none;
            background: linear-gradient(145deg, var(--bg-elevated), var(--bg-card));
            animation: cardFlip 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.4), 0 10px 40px rgba(0,0,0,0.3);
        }

        @keyframes cardFlip {
            0% { transform: rotateY(0deg) scale(1); }
            25% { transform: rotateY(20deg) scale(1.05); }
            50% { transform: rotateY(90deg) scale(1.1); box-shadow: 0 0 40px var(--primary); }
            75% { transform: rotateY(20deg) scale(1.05); }
            100% { transform: rotateY(0deg) scale(1); }
        }

        /* Spread Cards */
        .card-spread {
            display: flex;
            gap: -30px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 20px 10px;
        }

        .spread-card {
            width: 90px;
            height: 135px;
            background: linear-gradient(145deg, var(--bg-elevated), var(--bg-card));
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            user-select: none;
            -webkit-user-select: none;
        }

        .spread-card:nth-child(1) { transform: translateX(15px) rotate(-5deg); }
        .spread-card:nth-child(2) { transform: translateY(-8px); z-index: 2; }
        .spread-card:nth-child(3) { transform: translateX(-15px) rotate(5deg); }

        .spread-card.revealed:nth-child(1),
        .spread-card.revealed:nth-child(3) {
            transform: rotate(0deg);
        }
        .spread-card.revealed:nth-child(2) {
            transform: translateY(-8px);
        }

        .spread-card:hover {
            transform: translateY(-12px) scale(1.05) rotate(0deg) !important;
            z-index: 10;
            border-color: var(--secondary);
            box-shadow: 0 15px 35px rgba(245, 158, 11, 0.25);
        }

        .spread-card:active {
            transform: scale(0.95) !important;
            transition: transform 0.1s;
        }

        .spread-card.revealed {
            background: linear-gradient(145deg, #2a2a4a, #1a1a2e);
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
            animation: cardReveal 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes cardReveal {
            0% { transform: translateY(0) rotate(0); opacity: 0.5; }
            50% { transform: translateY(-20px) scale(1.1); opacity: 0.8; }
            100% { transform: translateY(0) rotate(0); opacity: 1; }
        }

        .spread-card.revealed:hover {
            transform: translateY(-8px) scale(1.02) rotate(0deg) !important;
        }

        .spread-card .card-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: absolute;
            bottom: 8px;
        }

        .card-symbol {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
        }

        .card-placeholder .card-symbol {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
        }

        /* Tap hint animation */
        @keyframes pulseTap {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .tap-hint {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--text-secondary);
            animation: pulseTap 2s ease-in-out infinite;
            white-space: nowrap;
            background: var(--bg-elevated);
            padding: 4px 12px;
            border-radius: 12px;
            margin-top: 8px;
        }

        /* Question Input */
        .question-section {
            margin: 32px 0;
            padding: 24px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .question-section label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .question-input {
            width: 100%;
            padding: 16px;
            background: var(--bg-elevated);
            border: 2px solid transparent;
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            transition: border-color 0.2s;
        }

        .question-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .question-input::placeholder {
            color: var(--text-secondary);
        }

        .question-input:focus + .char-count {
            color: var(--primary);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 56px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn-primary:active::after {
            width: 300px;
            height: 300px;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-secondary:active {
            transform: scale(0.98);
            background: var(--bg-card);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Clear/Reset button */
        #clearBtn {
            background: linear-gradient(135deg, var(--accent-purple), var(--primary));
        }

        /* Reading Result */
        .result-section {
            margin-top: 32px;
            padding: 24px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            display: none;
        }

        .result-section.show {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-card {
            padding: 20px;
            background: var(--bg-elevated);
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .result-card h3 {
            font-family: 'Cinzel', serif;
            color: var(--secondary);
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .result-card p {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .card-symbol {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        /* Mode Selection */
        .mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 8px 4px;
            padding-bottom: 12px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .mode-selector::-webkit-scrollbar {
            display: none;
        }

        .mode-btn {
            flex-shrink: 0;
            padding: 10px 16px;
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--accent-purple));
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .mode-btn:active {
            transform: scale(0.95);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--bg-elevated);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite, glow 2s ease-in-out infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px var(--primary), 0 0 20px rgba(99, 102, 241, 0.3); }
            50% { box-shadow: 0 0 20px var(--primary), 0 0 40px rgba(99, 102, 241, 0.5); }
        }

        .loading p {
            color: var(--text-secondary);
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 26, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.05);
            padding: 12px 20px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 20px));
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item span:first-child {
            font-size: 1.4rem;
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: calc(80px + env(safe-area-inset-bottom, 20px));
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 20px rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Responsive */
        @media (min-width: 600px) {
            .card-placeholder {
                width: 180px;
                height: 270px;
            }
            
            .spread-card {
                width: 110px;
                height: 165px;
                font-size: 2.5rem;
            }

            .spread-card .card-symbol {
                font-size: 2.5rem;
            }
        }

        /* Small phone adjustments */
        @media (max-width: 360px) {
            .hero h1 {
                font-size: 1.6rem;
            }

            .card-placeholder {
                width: 140px;
                height: 210px;
                font-size: 3rem;
            }

            .mode-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <header>
        <div class="header-content">
            <div class="logo">âœ¨ AI Tarot</div>
            <div class="header-actions">
                <button class="icon-btn" id="historyBtn" aria-label="History">ğŸ“œ</button>
                <button class="icon-btn" id="settingsBtn" aria-label="Settings">âš™ï¸</button>
            </div>
        </div>
    </header>

    <main>
        <section class="hero">
            <h1>ğŸ”® æ™ºèƒ½å¡”ç¾…ç‰Œå åœ</h1>
            <p>é¸æ“‡ç‰Œé™£é¡å‹ï¼Œå°ˆæ³¨ä½ çš„å•é¡Œ</p>
        </section>

        <div class="mode-selector" role="tablist" aria-label="é¸æ“‡ç‰Œé™£é¡å‹">
            <button class="mode-btn active" data-mode="single" role="tab" aria-selected="true">å–®ç‰Œ</button>
            <button class="mode-btn" data-mode="three" role="tab" aria-selected="false">ä¸‰ç‰Œ</button>
            <button class="mode-btn" data-mode="celtic" role="tab" aria-selected="false">å‡±çˆ¾ç‰¹</button>
            <button class="mode-btn" data-mode="horseshoe" role="tab" aria-selected="false">é¦¬è¹„éµ</button>
        </div>

        <div class="card-area" id="cardArea">
            <div class="card-placeholder" id="mainCard" role="button" aria-label="Tap to draw a card">
                âœ¨
            </div>
        </div>

        <section class="question-section">
            <label for="questionInput">å°ˆæ³¨æ–¼ä½ çš„å•é¡Œï¼ˆå¯é¸ï¼‰<span id="charCount" style="color: var(--text-secondary); font-weight: normal;">0/200</span></label>
            <textarea 
                class="question-input" 
                id="questionInput" 
                rows="3" 
                placeholder="ä¾‹å¦‚ï¼šæˆ‘æ‡‰è©²å¦‚ä½•æ”¹å–„æˆ‘çš„äº‹æ¥­ï¼Ÿ"
                maxlength="200"
            ></textarea>
        </section>

        <button class="btn btn-primary" id="drawBtn">
            <span>ğŸ”®</span> é–‹å§‹å åœ
        </button>

        <button class="btn btn-secondary" id="clearBtn" style="margin-top: 12px; display: none;">
            <span>ğŸ”„</span> é‡æ–°å åœ
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨æ´—ç‰Œ...</p>
        </div>

        <section class="result-section" id="resultSection">
            <div id="resultContent"></div>
            <button class="btn btn-secondary" id="shareBtn" style="margin-top: 16px;">
                <span>ğŸ“¤</span> åˆ†äº«çµæœ
            </button>
        </section>
    </main>

    <nav class="bottom-nav">
        <button class="nav-item active" data-page="home">
            <span>ğŸ </span>
            <span>é¦–é </span>
        </button>
        <button class="nav-item" data-page="readings">
            <span>ğŸ“–</span>
            <span>è§£è®€</span>
        </button>
        <button class="nav-item" data-page="daily">
            <span>ğŸŒŸ</span>
            <span>æ¯æ—¥</span>
        </button>
        <button class="nav-item" data-page="profile">
            <span>ğŸ‘¤</span>
            <span>æˆ‘çš„</span>
        </button>
    </nav>

    <div class="toast" id="toast"></div>

    <script>
        // Tarot Data
        const tarotCards = [
            { name: 'æ„šäºº', symbol: '0', keywords: 'æ–°é–‹å§‹ã€è‡ªç”±ã€å†’éšª', meaning: 'æ„šäººä»£è¡¨æ–°çš„é–‹å§‹å’Œç„¡é™çš„å¯èƒ½æ€§ã€‚å¡”ç¾…ç‰Œä¸­çš„ç¬¬ä¸€å¼µç‰Œè±¡å¾µè‘—å¤©çœŸã€ç´”ç²¹å’Œå°æœªçŸ¥çš„å‹‡æ•¢æ“æŠ±ã€‚é€™å¼µç‰Œå‘Šè¨´ä½ ï¼šæ”¾ä¸‹ææ‡¼ï¼Œæ¥å—ç”Ÿå‘½çš„å†’éšªã€‚' },
            { name: 'é­”è¡“å¸«', symbol: 'I', keywords: 'å‰µé€ ã€æ„å¿—åŠ›ã€æŠ€èƒ½', meaning: 'é­”è¡“å¸«ä»£è¡¨ä½ å…§åœ¨çš„æ½›åŠ›å’Œå‰µé€ åŠ›ã€‚ä»–æ‰‹æŒå››å…ƒç´ æ¬Šæ–ï¼Œæ„å‘³è‘—ä½ æœ‰èƒ½åŠ›å°‡æƒ³æ³•è½‰åŒ–ç‚ºç¾å¯¦ã€‚ç¾åœ¨æ˜¯æ™‚å€™é‹ç”¨ä½ çš„æŠ€èƒ½å’Œè³‡æºäº†ã€‚' },
            { name: 'å¥³ç¥­å¸', symbol: 'II', keywords: 'ç›´è¦ºã€æ™ºæ…§ã€ç¥ç§˜', meaning: 'å¥³ç¥­å¸è±¡å¾µè‘—å…§åœ¨çš„æ™ºæ…§å’Œç›´è¦ºã€‚å¥¹ååœ¨å…©æŸ±å­ä¹‹é–“ï¼Œä»£è¡¨çŸ¥è­˜èˆ‡ç†æ€§çš„å¹³è¡¡ã€‚è†è½ä½ å…§å¿ƒçš„è²éŸ³ï¼Œå®ƒæœƒå¼•å°ä½ æ­£ç¢ºçš„æ–¹å‘ã€‚' },
            { name: 'çš‡å', symbol: 'III', keywords: 'è±ç››ã€æ¯æ€§ã€å‰µé€ åŠ›', meaning: 'çš‡åä»£è¡¨è±ç››å’Œå‰µé€ åŠ›ã€‚å¥¹æ˜¯ç”Ÿå‘½çš„çµ¦äºˆè€…ï¼Œè±¡å¾µè‘—å­•è‚²ã€é—œæ‡·å’Œè—è¡“ã€‚ç¾åœ¨æ˜¯æ™‚å€™è®“ä½ çš„å‰µæ„é …ç›®ç¶»æ”¾äº†ã€‚' },
            { name: 'çš‡å¸', symbol: 'IV', keywords: 'æ¬Šå¨ã€ç©©å®šã€é ˜å°', meaning: 'çš‡å¸ä»£è¡¨çµæ§‹ã€æ¬Šå¨å’Œç©©å®šã€‚ä»–æ•™ä½ å¦‚ä½•å»ºç«‹ç§©åºå’Œç´€å¾‹ã€‚ç¾åœ¨æ˜¯æ™‚å€™å±•ç¾ä½ çš„é ˜å°èƒ½åŠ›äº†ã€‚' },
            { name: 'æ•™çš‡', symbol: 'V', keywords: 'å‚³çµ±ã€æŒ‡å°ã€åœ˜é«”', meaning: 'æ•™çš‡ä»£è¡¨å‚³çµ±åƒ¹å€¼å’Œåœ˜é«”æ„è­˜ã€‚ä»–è±¡å¾µè‘—æ•™è‚²å’Œå¿ƒéˆçš„æŒ‡å¼•ã€‚è€ƒæ…®å°‹æ±‚å°å¸«çš„å»ºè­°æˆ–åŠ å…¥æ”¯æŒä½ çš„åœ˜é«”ã€‚' },
            { name: 'æˆ€äºº', symbol: 'VI', keywords: 'æ„›ã€é¸æ“‡ã€å’Œè«§', meaning: 'æˆ€äººä»£è¡¨æ„›ã€é¸æ“‡å’Œå¤¥ä¼´é—œä¿‚ã€‚é€™å¼µç‰Œè¬›è¿°äº†åƒ¹å€¼è§€çš„å”èª¿èˆ‡é‡è¦çš„æ±ºå®šã€‚è·Ÿéšä½ å¿ƒçš„é¸æ“‡ã€‚' },
            { name: 'æˆ°è»Š', symbol: 'VII', keywords: 'å‹åˆ©ã€æ„å¿—ã€æ±ºå¿ƒ', meaning: 'æˆ°è»Šä»£è¡¨å…‹æœéšœç¤™å’Œå‹åˆ©ã€‚åªè¦è¶³æœ‰å¤ çš„æ„å¿—åŠ›ï¼Œä½ å°±èƒ½æˆ°å‹ä»»ä½•æŒ‘æˆ°ã€‚ä¿æŒå°ˆæ³¨ï¼Œå‘å‰é‚é€²ã€‚' },
            { name: 'åŠ›é‡', symbol: 'VIII', keywords: 'å‹‡æ°£ã€è€å¿ƒã€å…§åœ¨åŠ›é‡', meaning: 'åŠ›é‡ä»£è¡¨å…§åœ¨çš„å‹‡æ°£å’Œè€å¿ƒã€‚å®ƒä¸æ˜¯é—œæ–¼è »åŠ›ï¼Œè€Œæ˜¯é—œæ–¼æº«æŸ”åœ°æ§åˆ¶å…§å¿ƒçš„ç…å­ã€‚ä¿¡ä»»ä½ çš„éŸŒæ€§ã€‚' },
            { name: 'éš±å£«', symbol: 'IX', keywords: 'å…§çœã€æ™ºæ…§ã€æŒ‡å¼•', meaning: 'éš±å£«ä»£è¡¨å…§çœå’Œå°‹æ‰¾å…§åœ¨çš„ç­”æ¡ˆã€‚ç¾åœ¨æ˜¯æ™‚å€™é€€ä¸€æ­¥ï¼Œå‚¾è½ä½ å…§å¿ƒçš„æ™ºæ…§äº†ã€‚' },
            { name: 'å‘½é‹ä¹‹è¼ª', symbol: 'X', keywords: 'è½‰è®Šã€å‘½é‹ã€æ©Ÿæœƒ', meaning: 'å‘½é‹ä¹‹è¼ªè±¡å¾µç”Ÿå‘½çš„å¾ªç’°å’Œæ„æƒ³ä¸åˆ°çš„è½‰è®Šã€‚æ¥å—æ”¹è®Šï¼Œå› ç‚ºå®ƒå€‘å¯èƒ½å¸¶ä¾†æ–°çš„æ©Ÿæœƒã€‚' },
            { name: 'æ­£ç¾©', symbol: 'XI', keywords: 'å¹³è¡¡ã€çœŸç›¸ã€å…¬å¹³', meaning: 'æ­£ç¾©ä»£è¡¨å¹³è¡¡ã€çœŸç›¸å’Œå› æœã€‚ç¾åœ¨æ˜¯æ™‚å€™å°è‡ªå·±çš„è¡Œç‚ºè² è²¬äº†ã€‚çœŸç›¸æœƒæµ®å‡ºæ°´é¢ã€‚' },
            { name: 'åŠäºº', symbol: 'XII', keywords: 'æš«åœã€çŠ§ç‰²ã€è§€é»', meaning: 'åŠäººä»£è¡¨æš«æ™‚çš„åœé “å’ŒçŠ§ç‰²ã€‚æœ‰æ™‚ä½ éœ€è¦é€€å¾Œä¸€æ­¥ï¼Œä»¥ç²å¾—æ–°çš„è¦–è§’ã€‚é€™æ˜¯å…§åœ¨è½‰è®Šçš„æ™‚åˆ»ã€‚' },
            { name: 'æ­»äº¡', symbol: 'XIII', keywords: 'è½‰è®Šã€çµ‚çµã€é‡ç”Ÿ', meaning: 'æ­»äº¡ç‰Œä»£è¡¨è½‰è®Šå’Œçµ‚çµï¼Œä½†çµ‚çµæ˜¯å¦ä¸€å€‹é–‹å§‹ã€‚æ”¾ä¸‹èˆŠæœ‰çš„ï¼Œæ“æŠ±æ–°çš„ã€‚é€™æ˜¯è›»è®Šçš„æ™‚åˆ»ã€‚' },
            { name: 'ç¯€åˆ¶', symbol: 'XIV', keywords: 'å¹³è¡¡ã€è€å¿ƒã€ä¸­åº¸', meaning: 'ç¯€åˆ¶ä»£è¡¨å¹³è¡¡ã€è€å¿ƒå’Œ Moderationã€‚åœ¨è¡Œå‹•å’Œè¬¹æ…ä¹‹é–“æ‰¾åˆ°å’Œè«§ã€‚æº«å’Œåœ°å‰é€²æœƒè®“ä½ èµ°å¾—æ›´é ã€‚' },
            { name: 'æƒ¡é­”', symbol: 'XV', keywords: 'æŸç¸›ã€æ…¾æœ›ã€é™·é˜±', meaning: 'æƒ¡é­”ä»£è¡¨æŸç¸›å’Œæœªè§£æ±ºçš„æ…¾æœ›ã€‚æª¢æŸ¥æ˜¯å¦æœ‰è®“ä½ é™·å…¥è² é¢å¾ªç’°çš„ç¿’æ…£æˆ–é—œä¿‚ã€‚è¦ºå¯Ÿæ˜¯è§£è„«çš„ç¬¬ä¸€æ­¥ã€‚' },
            { name: 'å¡”', symbol: 'XVI', keywords: 'çªè®Šã€è§£æ”¾ã€è¦ºé†’', meaning: 'å¡”ä»£è¡¨çªç„¶çš„è®ŠåŒ–å’Œè¦ºé†’ã€‚é›–ç„¶å¯èƒ½æ˜¯ç—›è‹¦çš„ï¼Œä½†é€™äº›å‹•æ–æœƒå¹«åŠ©ä½ æ“ºè„«è™›å¹»çš„çµæ§‹ï¼Œç²å¾—çœŸæ­£çš„è‡ªç”±ã€‚' },
            { name: 'æ˜Ÿæ˜Ÿ', symbol: 'XVII', keywords: 'å¸Œæœ›ã€éˆæ„Ÿã€ç™‚ç™’', meaning: 'æ˜Ÿæ˜Ÿä»£è¡¨å¸Œæœ›ã€éˆæ„Ÿå’Œç™‚ç™’ã€‚åœ¨é»‘æš—ä¹‹å¾Œï¼Œå¥¹å¸¶ä¾†äº†ä¿¡å¿ƒçš„å›æ­¸ã€‚ç›¸ä¿¡æœªä¾†æœƒæ›´å¥½ã€‚' },
            { name: 'æœˆäº®', symbol: 'XVIII', keywords: 'ç›´è¦ºã€å¹»è±¡ã€ææ‡¼', meaning: 'æœˆäº®ä»£è¡¨æ½›æ„è­˜å’Œææ‡¼ã€‚å®ƒæé†’æˆ‘å€‘ä¸è¦è¢«å¹»è±¡æ¬ºé¨™ã€‚é¢å°ææ‡¼ï¼Œä½ æœƒç™¼ç¾å®ƒå€‘åªæ˜¯å½±å­ã€‚' },
            { name: 'å¤ªé™½', symbol: 'XIX', keywords: 'æˆåŠŸã€æ´»åŠ›ã€å¿«æ¨‚', meaning: 'å¤ªé™½ä»£è¡¨æˆåŠŸã€æ´»åŠ›å’Œå¿«æ¨‚ã€‚é€™æ˜¯å……æ»¿é™½å…‰çš„æ™‚åˆ»ã€‚äº«å—ä½ çš„æˆå°±å’Œç”Ÿå‘½çš„ç¾å¥½ã€‚' },
            { name: 'å¯©åˆ¤', symbol: 'XX', keywords: 'è¦ºé†’ã€å¯¬æ•ã€é‡ç”Ÿ', meaning: 'å¯©åˆ¤ä»£è¡¨è¦ºé†’å’Œå…§å¿ƒçš„å‘¼å–šã€‚é€™æ˜¯è©•ä¼°ä½ éå»è¡Œå‹•çš„æ™‚åˆ»ã€‚æº–å‚™å¥½å¾é ­é–‹å§‹ã€‚' },
            { name: 'ä¸–ç•Œ', symbol: 'XXI', keywords: 'å®Œæˆã€æˆå°±ã€å¾ªç’°', meaning: 'ä¸–ç•Œä»£è¡¨å®Œæˆå’Œæˆå°±ã€‚ä½ å·²ç¶“å®Œæˆäº†ä¸€å€‹å¾ªç’°ã€‚æ…¶ç¥ä½ çš„æˆåŠŸï¼Œé€™æ˜¯ä¸€å€‹æ–°é–‹å§‹çš„é–€æª»ã€‚' }
        ];

        // App State
        let currentMode = 'single';
        let selectedCards = [];
        let readings = JSON.parse(localStorage.getItem('tarotReadings') || '[]');

        // Elements
        const mainCard = document.getElementById('mainCard');
        const cardArea = document.getElementById('cardArea');
        const drawBtn = document.getElementById('drawBtn');
        const clearBtn = document.getElementById('clearBtn');
        const questionInput = document.getElementById('questionInput');
        const charCount = document.getElementById('charCount');
        const resultSection = document.getElementById('resultSection');
        const resultContent = document.getElementById('resultContent');
        const loading = document.getElementById('loading');
        const toast = document.getElementById('toast');

        // Character counter for question input
        questionInput.addEventListener('input', () => {
            const length = questionInput.value.length;
            charCount.textContent = `${length}/200`;
            charCount.style.color = length > 180 ? 'var(--error)' : 'var(--text-secondary)';
        });

        // Mode Selection
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-selected', 'false');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');
                currentMode = btn.dataset.mode;
                resetCards();
            });
        });

        // Card Click
        mainCard.addEventListener('click', handleCardDraw);
        mainCard.addEventListener('touchstart', handleCardTouchStart, { passive: true });
        mainCard.addEventListener('touchend', handleCardTouchEnd);

        // Draw Button
        drawBtn.addEventListener('click', handleCardDraw);
        
        // Loading messages
        const loadingMessages = [
            'æ­£åœ¨æ´—ç‰Œ...',
            'å¡”ç¾…ç‰Œæ­£åœ¨æ€è€ƒ...',
            'å®‡å®™èƒ½é‡èšé›†ä¸­...',
            'è§£è®€ä½ çš„å‘½é‹...'
        ];
        
        function updateLoadingMessage() {
            const loadingText = loading.querySelector('p');
            if (loadingText) {
                loadingText.textContent = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
            }
        }
        
        // Clear Button - reset for new reading
        clearBtn.addEventListener('click', () => {
            clearBtn.style.display = 'none';
            drawBtn.style.display = 'flex';
            questionInput.value = '';
            resetCards();
            resultSection.classList.remove('show');
        });

        // Touch feedback handlers
        function handleCardTouchStart(e) {
            if (e.target.closest('.card-placeholder')) {
                e.target.closest('.card-placeholder').classList.add('tapping');
            }
        }

        function handleCardTouchEnd(e) {
            if (e.target.closest('.card-placeholder')) {
                e.target.closest('.card-placeholder').classList.remove('tapping');
            }
        }

        function handleCardDraw(e) {
            if (drawBtn.disabled) return;
            
            drawBtn.disabled = true;
            drawBtn.innerHTML = '<span class="spinner" style="width:20px;height:20px;border-width:2px;"></span> æŠ½ç‰Œä¸­...';
            updateLoadingMessage();
            loading.classList.add('show');
            resultSection.classList.remove('show');
            
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(50);
            
            setTimeout(() => {
                loading.classList.remove('show');
                
                // Shuffle and pick cards
                const shuffled = [...tarotCards].sort(() => Math.random() - 0.5);
                const numCards = currentMode === 'single' ? 1 : currentMode === 'three' ? 3 : currentMode === 'celtic' ? 5 : 7;
                selectedCards = shuffled.slice(0, numCards);
                
                displayCards();
                generateReading();
                drawBtn.disabled = false;
                drawBtn.innerHTML = '<span>ğŸ”®</span> é–‹å§‹å åœ';
                
                // Scroll to results on mobile
                if (window.innerWidth < 600) {
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
                // Haptic feedback
                if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
            }, 1500);
        }

        // Reset Cards
        function resetCards() {
            selectedCards = [];
            resultSection.classList.remove('show');
            
            if (currentMode === 'single') {
                cardArea.innerHTML = `
                    <div class="card-placeholder" id="mainCard" role="button" aria-label="Tap to draw a card">
                        âœ¨
                    </div>
                `;
            } else {
                const labels = currentMode === 'three' ? ['éå»', 'ç¾åœ¨', 'æœªä¾†'] : 
                              currentMode === 'celtic' ? ['éå»', 'ç¾åœ¨', 'æœªä¾†', 'æŒ‘æˆ°', 'çµæœ'] :
                              ['1', '2', '3', '4', '5', '6', '7'];
                
                cardArea.innerHTML = `
                    <div class="card-spread">
                        ${labels.slice(0, currentMode === 'three' ? 3 : currentMode === 'celtic' ? 5 : 7).map((label, i) => `
                            <div class="spread-card" data-index="${i}" role="button" aria-label="Card ${i+1}">
                                âœ¨
                                <span class="card-label">${label}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.querySelectorAll('.spread-card').forEach(card => {
                    card.addEventListener('click', () => revealCard(parseInt(card.dataset.index)));
                });
            }
            
            // Re-attach main card listeners
            const newMainCard = document.getElementById('mainCard');
            if (newMainCard) {
                newMainCard.addEventListener('click', handleCardDraw);
                newMainCard.addEventListener('touchstart', handleCardTouchStart, { passive: true });
                newMainCard.addEventListener('touchend', handleCardTouchEnd);
            }
            
            // Add tap hint for single card mode
            if (currentMode === 'single') {
                const hint = document.createElement('div');
                hint.className = 'tap-hint';
                hint.textContent = 'ğŸ‘† é»æ“ŠæŠ½ç‰Œ';
                cardArea.appendChild(hint);
            }
        }

        // Draw Cards
        function drawCards() {
            if (drawBtn.disabled) return;
            
            drawBtn.disabled = true;
            loading.classList.add('show');
            resultSection.classList.remove('show');
            
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(50);
            
            setTimeout(() => {
                loading.classList.remove('show');
                
                // Shuffle and pick cards
                const shuffled = [...tarotCards].sort(() => Math.random() - 0.5);
                const numCards = currentMode === 'single' ? 1 : currentMode === 'three' ? 3 : currentMode === 'celtic' ? 5 : 7;
                selectedCards = shuffled.slice(0, numCards);
                
                displayCards();
                generateReading();
                drawBtn.disabled = false;
                
                // Haptic feedback
                if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
            }, 1500);
        }

        // Display Cards
        function displayCards() {
            // Remove tap hint
            const hint = document.querySelector('.tap-hint');
            if (hint) hint.remove();
            
            if (currentMode === 'single') {
                const card = selectedCards[0];
                mainCard.innerHTML = `<span class="card-symbol">${card.symbol}</span>`;
                mainCard.classList.add('revealed');
            } else {
                const cards = document.querySelectorAll('.spread-card');
                cards.forEach((cardEl, i) => {
                    cardEl.innerHTML = `
                        <span class="card-symbol">${selectedCards[i].symbol}</span>
                        <span class="card-label">${cardEl.querySelector('.card-label').textContent}</span>
                    `;
                    cardEl.classList.add('revealed');
                });
            }
        }

        // Reveal individual card (for spread)
        function revealCard(index) {
            if (selectedCards[index]) return;
            
            const shuffled = [...tarotCards].sort(() => Math.random() - 0.5);
            selectedCards[index] = shuffled[0];
            
            const cardEl = document.querySelector(`.spread-card[data-index="${index}"]`);
            cardEl.innerHTML = `
                <span class="card-symbol">${selectedCards[index].symbol}</span>
                <span class="card-label">${cardEl.querySelector('.card-label').textContent}</span>
            `;
            cardEl.classList.add('revealed');
            
            if (navigator.vibrate) navigator.vibrate(30);
        }

        // Generate Reading
        function generateReading() {
            const question = questionInput.value.trim() || 'å¡”ç¾…ç‰Œçš„æŒ‡å¼•';
            
            let readingHTML = '';
            
            if (currentMode === 'single') {
                const card = selectedCards[0];
                readingHTML = `
                    <div class="result-card">
                        <div class="card-symbol">${card.symbol}</div>
                        <h3>${card.name}</h3>
                        <p><strong>é—œéµè©ï¼š</strong>${card.keywords}</p>
                        <p style="margin-top: 12px;">${card.meaning}</p>
                    </div>
                `;
            } else {
                const positions = currentMode === 'three' ? ['éå»', 'ç¾åœ¨', 'æœªä¾†'] :
                                  currentMode === 'celtic' ? ['éå»', 'ç¾åœ¨', 'æœªä¾†', 'æŒ‘æˆ°', 'çµæœ'] :
                                  ['ä½ç½®1', 'ä½ç½®2', 'ä½ç½®3', 'ä½ç½®4', 'ä½ç½®5', 'ä½ç½®6', 'ä½ç½®7'];
                
                selectedCards.forEach((card, i) => {
                    readingHTML += `
                        <div class="result-card">
                            <div class="card-symbol">${card.symbol}</div>
                            <h3>${positions[i]} - ${card.name}</h3>
                            <p><strong>é—œéµè©ï¼š</strong>${card.keywords}</p>
                            <p style="margin-top: 12px;">${card.meaning}</p>
                        </div>
                    `;
                });
            }
            
            resultContent.innerHTML = readingHTML;
            resultSection.classList.add('show');
            
            // Show clear button, hide draw button
            drawBtn.style.display = 'none';
            clearBtn.style.display = 'flex';
            
            // Save reading
            const reading = {
                id: Date.now(),
                date: new Date().toISOString(),
                mode: currentMode,
                question: question,
                cards: selectedCards.map(c => c.name)
            };
            readings.unshift(reading);
            localStorage.setItem('tarotReadings', JSON.stringify(readings.slice(0, 50)));
        }

        // Toast
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Share Button
        document.getElementById('shareBtn').addEventListener('click', () => {
            const question = questionInput.value.trim() || 'å¡”ç¾…ç‰Œå åœ';
            let shareText = `ğŸ”® AI Tarot å åœçµæœ\n\nå•é¡Œï¼š${question}\n\n`;
            
            selectedCards.forEach((card, i) => {
                const positions = ['', 'éå»', 'ç¾åœ¨', 'æœªä¾†', 'æŒ‘æˆ°', 'çµæœ'];
                const pos = positions[i] ? `${positions[i]} - ` : '';
                shareText += `${pos}${card.name}: ${card.keywords}\n`;
            });
            
            shareText += `\n#AITarot #å¡”ç¾…ç‰Œ`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AI Tarot å åœçµæœ',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText);
                showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }
        });

        // Bottom Nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                if (page === 'readings') {
                    showHistory();
                } else if (page === 'home') {
                    resetCards();
                }
            });
        });

        // History
        document.getElementById('historyBtn').addEventListener('click', showHistory);

        function showHistory() {
            // Switch to home tab first
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector('.nav-item[data-page="home"]').classList.add('active');
            
            if (readings.length === 0) {
                cardArea.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ“œ</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 8px;">æš«ç„¡è¨˜éŒ„</h3>
                        <p style="color: var(--text-secondary);">å®Œæˆå åœå¾Œæœƒè‡ªå‹•ä¿å­˜</p>
                    </div>
                `;
                resultSection.classList.remove('show');
                drawBtn.style.display = 'flex';
                clearBtn.style.display = 'none';
                return;
            }
            
            let historyHTML = '<h3 style="margin-bottom: 16px; font-family: Cinzel, serif;">ğŸ“œ éå¾€å åœ</h3>';
            readings.slice(0, 10).forEach(reading => {
                const date = new Date(reading.date).toLocaleDateString('zh-TW', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const modeNames = { single: 'å–®ç‰Œ', three: 'ä¸‰ç‰Œ', celtic: 'å‡±çˆ¾ç‰¹', horseshoe: 'é¦¬è¹„éµ' };
                historyHTML += `
                    <div class="result-card" style="cursor: pointer;" onclick="showReadingDetail(${reading.id})">
                        <p style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${date}</strong>
                            <span style="background: var(--primary); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">${modeNames[reading.mode] || reading.mode}</span>
                        </p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 8px;">${reading.question}</p>
                        <p style="color: var(--secondary); margin-top: 8px;">${reading.cards.join(' â€¢ ')}</p>
                    </div>
                `;
            });
            
            resultContent.innerHTML = historyHTML;
            resultSection.classList.add('show');
            drawBtn.style.display = 'none';
            clearBtn.style.display = 'flex';
            
            // Scroll to results
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Show individual reading detail
        function showReadingDetail(id) {
            const reading = readings.find(r => r.id === id);
            if (!reading) return;
            
            const modeNames = { single: 'å–®ç‰Œ', three: 'ä¸‰ç‰Œ', celtic: 'å‡±çˆ¾ç‰¹', horseshoe: 'é¦¬è¹„éµ' };
            const positions = ['', 'éå»', 'ç¾åœ¨', 'æœªä¾†', 'æŒ‘æˆ°', 'çµæœ'];
            
            let detailHTML = `<button onclick="showHistory()" style="background: var(--bg-elevated); border: none; color: var(--text-secondary); padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-bottom: 16px;">â† è¿”å›</button>`;
            detailHTML += `<h3 style="margin-bottom: 16px; font-family: Cinzel, serif;">${modeNames[reading.mode]} - ${reading.question}</h3>`;
            
            reading.cards.forEach((cardName, i) => {
                const card = tarotCards.find(c => c.name === cardName);
                if (card) {
                    detailHTML += `
                        <div class="result-card">
                            <div class="card-symbol">${card.symbol}</div>
                            <h3>${positions[i] || ''} ${card.name}</h3>
                            <p><strong>é—œéµè©ï¼š</strong>${card.keywords}</p>
                            <p style="margin-top: 12px;">${card.meaning}</p>
                        </div>
                    `;
                }
            });
            
            resultContent.innerHTML = detailHTML;
        }

        // Initialize
        resetCards();

        // Offline indicator
        const offlineToast = document.createElement('div');
        offlineToast.id = 'offlineToast';
        offlineToast.style.cssText = 'position:fixed;top:calc(50px + env(safe-area-inset-top));left:50%;transform:translateX(-50%);background:var(--error);color:white;padding:8px 16px;border-radius:20px;font-size:0.8rem;z-index:300;display:none;';
        offlineToast.textContent = 'ğŸ“´ é›¢ç·šæ¨¡å¼';
        document.body.appendChild(offlineToast);

        window.addEventListener('online', () => {
            offlineToast.style.display = 'none';
            showToast('âœ… å·²æ¢å¾©é€£ç·š');
        });
        window.addEventListener('offline', () => {
            offlineToast.style.display = 'block';
        });
        if (!navigator.onLine) offlineToast.style.display = 'block';

        // App Install Prompt
        let deferredPrompt;
        const installBanner = document.createElement('div');
        installBanner.id = 'installBanner';
        installBanner.style.cssText = 'position:fixed;bottom:80px;left:20px;right:20px;background:linear-gradient(135deg,var(--primary),var(--accent-purple));padding:16px 20px;border-radius:16px;z-index:200;display:none;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(99,102,241,0.4);';
        installBanner.innerHTML = '<span style="color:white;font-weight:500;">ğŸ“² å®‰è£æ‡‰ç”¨ç¨‹å¼</span><button id="installBtn" style="background:white;color:var(--primary);border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;">å®‰è£</button>';
        document.body.appendChild(installBanner);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!localStorage.getItem('pwaInstalled')) {
                setTimeout(() => { installBanner.style.display = 'flex'; }, 3000);
            }
        });

        document.getElementById('installBtn')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    localStorage.setItem('pwaInstalled', 'true');
                    installBanner.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // Service Worker Registration with update detection
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => {
                    console.log('SW registered:', reg.scope);
                    // Check for updates
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showToast('ğŸ”„ æ–°ç‰ˆæœ¬å·²å°±ç·’ï¼Œè«‹åˆ·æ–°é é¢');
                            }
                        });
                    });
                })
                .catch(err => console.log('SW error:', err));
        }
        
        // Check for app update on visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && 'serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg && reg.waiting) {
                        showToast('ğŸ”„ è«‹åˆ·æ–°ä»¥ç²ï¿½æœ€æ–°ç‰ˆæœ¬');
                    }
                });
            }
        });
    </script>
</body>
</html>
